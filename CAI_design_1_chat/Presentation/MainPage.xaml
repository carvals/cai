<Page x:Class="CAI_design_1_chat.Presentation.MainPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:CAI_design_1_chat.Presentation"
      xmlns:controls="using:CAI_design_1_chat.Presentation.Controls"
      xmlns:uen="using:Uno.Extensions.Navigation.UI"
      xmlns:utu="using:Uno.Toolkit.UI"
      xmlns:um="using:Uno.Material"
      NavigationCacheMode="Required"
      Background="{ThemeResource MaterialBackgroundBrush}">
  
  <Grid utu:SafeArea.Insets="VisibleBounds">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>
    
    <!-- Navigation Bar with Tabs -->
    <Border Grid.Row="0" 
            Background="{ThemeResource MaterialSurfaceBrush}"
            BorderBrush="{ThemeResource MaterialOutlineBrush}"
            BorderThickness="0,0,0,1">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>
        
        <!-- Tab Navigation -->
        <StackPanel Grid.Column="0" 
                    Orientation="Horizontal" 
                    Margin="16,8">
          <Button x:Name="ChatTabButton"
                  Content="Chat"
                  Click="ChatTabButton_Click"
                  Background="{ThemeResource MaterialPrimaryBrush}"
                  Foreground="{ThemeResource MaterialOnPrimaryBrush}"
                  BorderThickness="0"
                  CornerRadius="20"
                  Padding="16,8"
                  Margin="0,0,8,0"
                  FontWeight="Medium" />
          <Button x:Name="MacroTabButton"
                  Content="Macro"
                  Click="MacroTabButton_Click"
                  Background="#19FFFFFF"
                  Foreground="#DCFFFFFF"
                  BorderBrush="#28FFFFFF"
                  BorderThickness="1"
                  CornerRadius="20"
                  Padding="16,8"
                  FontWeight="Medium" />
        </StackPanel>
        
        <!-- Right side navigation with AI settings -->
        <StackPanel Grid.Column="1" 
                    Orientation="Horizontal" 
                    Margin="16,8"
                    Spacing="5">
          <!-- AI Model Indicator -->
          <TextBlock x:Name="AIModelIndicator"
                     Text="Select an AI provider"
                     Foreground="White"
                     VerticalAlignment="Center"
                     FontSize="14"
                     FontWeight="Medium"
                     MaxWidth="200"
                     TextTrimming="CharacterEllipsis" />
          
          <!-- AI Settings Button -->
          <Button x:Name="GlobalAISettingsButton"
                  Click="AISettingsButton_Click"
                  Background="{ThemeResource MaterialPrimaryContainerBrush}"
                  BorderBrush="{ThemeResource MaterialPrimaryBrush}"
                  BorderThickness="1"
                  CornerRadius="20"
                  Padding="12,6"
                  ToolTipService.ToolTip="AI Settings">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <FontIcon Glyph="🤖" 
                        Foreground="{ThemeResource MaterialPrimaryBrush}"
                        FontSize="16" />
              <TextBlock Text="AI Settings"
                         Foreground="{ThemeResource MaterialPrimaryBrush}"
                         FontSize="14"
                         FontWeight="Medium" />
            </StackPanel>
          </Button>
        </StackPanel>
      </Grid>
    </Border>
    
    <!-- Main Content Grid -->
    <Grid Grid.Row="1">
      <Grid.ColumnDefinitions>
        <!-- Fixed far-left sidebar (61px) -->
        <ColumnDefinition Width="61" />
        <!-- Left panel (collapsible) -->
        <ColumnDefinition x:Name="LeftPanelColumn" Width="360" />
        <!-- Splitter -->
        <ColumnDefinition x:Name="SplitterColumn" Width="Auto" />
        <!-- Right panel (chat) -->
        <ColumnDefinition Width="*" MinWidth="320" />
      </Grid.ColumnDefinitions>
      
      <!-- Far-left Sidebar (icons only) -->
      <Border x:Name="FarLeftSidebar"
              Grid.Column="0" 
              Background="{ThemeResource MaterialSurfaceBrush}"
              BorderBrush="{ThemeResource MaterialOutlineBrush}"
              BorderThickness="0,0,1,0"
              Visibility="Visible">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>
          
          <!-- Navigation buttons section -->
          <StackPanel Grid.Row="0" Margin="6,8,6,0" Spacing="4">
            <!-- Toggle button for left panel (Espace de travail) -->
            <AppBarButton x:Name="ToggleLeftPanelButton"
                          Click="ToggleLeftPanelButton_Click"
                          Width="48"
                          Height="48"
                          ToolTipService.ToolTip="Toggle workspace panel">
              <AppBarButton.Icon>
                <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}"
                          Glyph="&#xE8F4;"/>
              </AppBarButton.Icon>
            </AppBarButton>
            
            <!-- Context button -->
            <AppBarButton x:Name="ContextButton"
                          Click="ContextButton_Click"
                          Width="48"
                          Height="48"
                          ToolTipService.ToolTip="Context">
              <AppBarButton.Icon>
                <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}"
                          Glyph="&#xE8A5;"/>
              </AppBarButton.Icon>
            </AppBarButton>
            
            <!-- Instruction Shortcuts button -->
            <AppBarButton x:Name="InstructionShortcutsButton"
                          Click="InstructionShortcutsButton_Click"
                          Width="48"
                          Height="48"
                          ToolTipService.ToolTip="Instruction Shortcuts">
              <AppBarButton.Icon>
                <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}"
                          Glyph="&#xE945;"/>
              </AppBarButton.Icon>
            </AppBarButton>
            
          </StackPanel>
          
          <!-- Settings section with expandable menu -->
          <StackPanel x:Name="SettingsSection" Grid.Row="2" Margin="6,0,6,4">
              <!-- Settings Button -->
              <AppBarButton x:Name="SettingsButton"
                            Click="SettingsButton_Click"
                            Width="48"
                            Height="48"
                            ToolTipService.ToolTip="Settings">
                <AppBarButton.Icon>
                  <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}"
                            Glyph="&#xE713;"/>
                </AppBarButton.Icon>
              </AppBarButton>
            
            <!-- Expandable settings menu -->
            <StackPanel x:Name="SettingsMenu"
                        Visibility="Collapsed"
                        Margin="0,4,0,0">
              
              <!-- Notifications -->
              <Button x:Name="NotificationsButton"
                      Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                      BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                      BorderThickness="1"
                      CornerRadius="6"
                      Width="48"
                      Height="48"
                      Margin="0,0,0,4"
                      ToolTipService.ToolTip="Notifications">
                <FontIcon Glyph="🔔" 
                          Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                          FontSize="18" />
              </Button>
              
              <!-- Theme -->
              <Button x:Name="ThemeButton"
                      Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                      BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                      BorderThickness="1"
                      CornerRadius="6"
                      Width="48"
                      Height="48"
                      Margin="0,0,0,4"
                      ToolTipService.ToolTip="Theme">
                <FontIcon Glyph="☀" 
                          Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                          FontSize="18" />
              </Button>
              
              <!-- Help -->
              <Button x:Name="HelpButton"
                      Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                      BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                      BorderThickness="1"
                      CornerRadius="6"
                      Width="48"
                      Height="48"
                      Margin="0,0,0,4"
                      ToolTipService.ToolTip="Help">
                <FontIcon Glyph="❓" 
                          Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                          FontSize="18" />
              </Button>
              
            </StackPanel>
          </StackPanel>
          
          <!-- Login avatar at bottom -->
          <Button x:Name="LoginAvatarButton"
                  Grid.Row="3"
                  Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                  BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                  BorderThickness="1"
                  CornerRadius="24"
                  Width="48"
                  Height="48"
                  Margin="6,0,6,8"
                  ToolTipService.ToolTip="User profile">
            <PersonPicture Width="40" Height="40" />
          </Button>
        </Grid>
      </Border>
      
      <!-- Left Panel: Switchable Content -->
      <Border x:Name="LeftPanel"
              Grid.Column="1"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="8"
              Margin="8">
        <Grid>
          <!-- Workspace Panel -->
          <Grid x:Name="WorkspacePanel" Visibility="Visible">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            
            <!-- Header -->
            <Border Grid.Row="0"
                    Background="{ThemeResource LayerFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="0,0,0,1"
                    CornerRadius="8,8,0,0"
                    Padding="16,12">
              <TextBlock Text="Espace de travail"
                         FontWeight="SemiBold"
                         FontSize="16" />
            </Border>
            
            <!-- Content -->
            <StackPanel Grid.Row="1" 
                        Margin="16"
                        Spacing="8">
            
            <Button x:Name="BtnAddFile"
                    HorizontalAlignment="Stretch"
                    Background="#19FFFFFF"
                    BorderBrush="#28FFFFFF"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="12,8"
                    Click="BtnAddFile_Click">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <FontIcon Glyph="&#xE109;" FontSize="16" Foreground="#DCFFFFFF" />
                <TextBlock Text="Ajouter un fichier" Foreground="#DCFFFFFF" />
              </StackPanel>
            </Button>
            
            <!-- Rechercher un fichier button -->
            <Button x:Name="BtnSearchFile"
                    Click="BtnSearchFile_Click"
                    HorizontalAlignment="Stretch"
                    Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                    BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="12,8">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <FontIcon Glyph="&#xE11A;" FontSize="16" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                <TextBlock Text="Rechercher un fichier" Foreground="{ThemeResource TextFillColorPrimaryBrush}" FontWeight="Medium" />
              </StackPanel>
            </Button>
            
            <!-- Créer un document button -->
            <Button x:Name="BtnCreateDocument"
                    HorizontalAlignment="Stretch"
                    Background="{ThemeResource SubtleFillColorSecondaryBrush}"
                    BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="12,8">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <FontIcon Glyph="&#xE8A5;" FontSize="16" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                <TextBlock Text="Créer un document" Foreground="{ThemeResource TextFillColorPrimaryBrush}" FontWeight="Medium" />
              </StackPanel>
            </Button>
            
          </StackPanel>
          </Grid>
          
          <!-- Context Panel -->
          <controls:ContextPanel x:Name="ContextPanelControl" 
                                 Visibility="Collapsed" />
          
          <!-- Instruction Shortcuts Panel -->
          <controls:InstructionShortcutsPanel x:Name="InstructionShortcutsPanel" 
                                              Visibility="Collapsed" />
          
        </Grid>
      </Border>
      
      <!-- Splitter -->
      <Border x:Name="Splitter"
              Grid.Column="2"
              Width="4"
              Background="{ThemeResource ControlStrokeColorDefaultBrush}"
              HorizontalAlignment="Center"
              VerticalAlignment="Stretch" />
      
      <!-- Right Panel: Chat -->
      <Border Grid.Column="3"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
              BorderThickness="1"
              CornerRadius="8"
              Margin="8">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>
          
          <!-- FileUpload Overlay - Positioned within chat content area -->
          <Grid x:Name="FileUploadOverlay" 
                Grid.RowSpan="3"
                Visibility="Collapsed" 
                Canvas.ZIndex="1000"
                Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
            
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header Navigation Bar -->
            <Border Grid.Row="0" 
                    Background="{ThemeResource MaterialSurfaceBrush}"
                    BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="24,16">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto"/>
                  <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Back Button -->
                <Button Grid.Column="0"
                        x:Name="BackToChatButton"
                        Click="BackToChatButton_Click"
                        Background="#19FFFFFF"
                        BorderBrush="#28FFFFFF"
                        BorderThickness="1"
                        CornerRadius="6"
                        Padding="12,8"
                        ToolTipService.ToolTip="Back">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE72B;" 
                              FontSize="16" 
                              Foreground="#DCFFFFFF"/>
                    <TextBlock Text="Back"
                               Foreground="#DCFFFFFF"
                               FontWeight="Medium"/>
                  </StackPanel>
                </Button>

                <!-- Page Title -->
                <TextBlock Grid.Column="1"
                           Text="File Processing"
                           Style="{ThemeResource TitleTextBlockStyle}"
                           Foreground="{ThemeResource MaterialOnSurfaceBrush}"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"
                           FontWeight="SemiBold"/>
              </Grid>
            </Border>

            <!-- Main Content Area -->
            <Grid Grid.Row="1" Margin="24">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="1*"/>
                <ColumnDefinition Width="20"/>
                <ColumnDefinition Width="2*"/>
              </Grid.ColumnDefinitions>

              <!-- Left Panel: Redesigned Layout -->
              <Border Grid.Column="0"
                      Background="{ThemeResource MaterialSurfaceBrush}"
                      BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                      BorderThickness="1"
                      CornerRadius="12"
                      Padding="24">
                <StackPanel Spacing="8">
                  <!-- Upload File Header -->
                  <TextBlock Text="Upload File"
                             Style="{ThemeResource SubtitleTextBlockStyle}"
                             Foreground="{ThemeResource MaterialOnSurfaceBrush}"
                             FontWeight="SemiBold"
                             HorizontalAlignment="Center"
                             Margin="0,0,0,4"/>

                  <!-- Browse Files Button -->
                  <Button x:Name="OverlayBrowseButton"
                          Content="Browse Files"
                          Background="{ThemeResource MaterialPrimaryBrush}"
                          Foreground="{ThemeResource MaterialOnPrimaryBrush}"
                          BorderThickness="0"
                          CornerRadius="8"
                          Padding="16,12"
                          HorizontalAlignment="Stretch"
                          FontWeight="Medium"
                          Click="OverlayBrowseButton_Click"/>

                  <!-- Selected File Info -->
                  <Border x:Name="OverlaySelectedFilePanel"
                          Background="{ThemeResource MaterialSurfaceVariantBrush}"
                          BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                          BorderThickness="1"
                          CornerRadius="8"
                          Padding="12"
                          Margin="0,8,0,0"
                          Visibility="Collapsed">
                    <StackPanel Spacing="4">
                      <TextBlock Text="Selected File:"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                                 FontWeight="Medium"/>
                      <TextBlock x:Name="OverlaySelectedFileName"
                                 Text=""
                                 Style="{ThemeResource BodyTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceBrush}"
                                 FontWeight="Medium"
                                 TextWrapping="Wrap"/>
                      <TextBlock x:Name="OverlaySelectedFileSize"
                                 Text=""
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"/>
                      
                      <!-- Rename File Section -->
                      <TextBlock Text="Rename file to:"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                                 FontWeight="Medium"
                                 Margin="0,8,0,4"/>
                      <TextBox x:Name="OverlayFileDisplayNameTextBox"
                               PlaceholderText="Enter display name (min 4 characters)"
                               Background="{ThemeResource MaterialSurfaceBrush}"
                               BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                               BorderThickness="1"
                               CornerRadius="4"
                               Padding="8,6"
                               FontSize="14"
                               TextChanged="OverlayFileDisplayNameTextBox_TextChanged"/>
                    </StackPanel>
                  </Border>

                  <!-- Divider -->
                  <Border Height="1" 
                          Background="{ThemeResource MaterialOutlineVariantBrush}" 
                          Margin="0,8"/>

                  <!-- File Processing Actions -->
                  <TextBlock Text="Créer un document"
                             Style="{ThemeResource CaptionTextBlockStyle}"
                             Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                             FontWeight="Medium"
                             Margin="0,4,0,8"/>

                  <!-- Extract Text Button -->
                  <Button x:Name="OverlayConvertToTextButton"
                          Content="Extract Text"
                          Background="{ThemeResource MaterialSecondaryBrush}"
                          Foreground="{ThemeResource MaterialOnSecondaryBrush}"
                          BorderThickness="0"
                          CornerRadius="8"
                          Padding="16,12"
                          HorizontalAlignment="Stretch"
                          FontWeight="Medium"
                          IsEnabled="False"
                          Click="OverlayConvertToTextButton_Click"/>

                  <!-- Generate Summary Button -->
                  <Button x:Name="OverlayGenerateSummaryButton"
                          Content="Generate Summary"
                          Background="{ThemeResource MaterialTertiaryBrush}"
                          Foreground="{ThemeResource MaterialOnTertiaryBrush}"
                          BorderThickness="0"
                          CornerRadius="8"
                          Padding="16,12"
                          HorizontalAlignment="Stretch"
                          FontWeight="Medium"
                          IsEnabled="False"
                          Click="OverlayGenerateSummaryButton_Click"/>

                  <!-- Save to Database Button -->
                  <Button x:Name="OverlaySaveButton"
                          Content="Save to Database"
                          Background="{ThemeResource MaterialSuccessBrush}"
                          Foreground="White"
                          BorderThickness="0"
                          CornerRadius="8"
                          Padding="16,12"
                          HorizontalAlignment="Stretch"
                          FontWeight="Medium"
                          IsEnabled="False"
                          Click="OverlaySaveButton_Click"/>

                  <!-- Reset Button -->
                  <Button x:Name="OverlayResetButton"
                          Content="Reset"
                          Background="#19FFFFFF"
                          Foreground="#DCFFFFFF"
                          BorderBrush="#28FFFFFF"
                          BorderThickness="1"
                          CornerRadius="6"
                          Padding="16,12"
                          HorizontalAlignment="Stretch"
                          FontWeight="Medium"
                          Click="OverlayResetButton_Click"/>

                  <!-- Divider -->
                  <Border Height="1" 
                          Background="{ThemeResource MaterialOutlineVariantBrush}" 
                          Margin="0,16,0,8"/>

                  <!-- Summary Instructions -->
                  <TextBlock Text="Summary Instructions"
                             Style="{ThemeResource CaptionTextBlockStyle}"
                             Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                             FontWeight="Medium"
                             Margin="0,0,0,8"/>

                  <!-- Custom Instructions TextBox -->
                  <TextBox x:Name="OverlaySummaryInstructionTextBox"
                           PlaceholderText="Enter custom instructions for AI summary..."
                           Background="{ThemeResource MaterialSurfaceVariantBrush}"
                           BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                           BorderThickness="1"
                           CornerRadius="8"
                           Padding="12"
                           MinHeight="80"
                           TextWrapping="Wrap"
                           AcceptsReturn="True"
                           ScrollViewer.VerticalScrollBarVisibility="Auto"
                           TextChanged="OverlaySummaryInstructionTextBox_TextChanged"/>

                  <!-- Instruction Buttons -->
                  <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                    <Button x:Name="OverlaySearchInstructionsButton"
                            Content="🔍 Search"
                            Background="{ThemeResource MaterialSurfaceVariantBrush}"
                            Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                            BorderThickness="0"
                            CornerRadius="6"
                            Padding="12,8"
                            FontSize="12"
                            Click="OverlaySearchInstructionsButton_Click"/>
                    
                    <Button x:Name="OverlaySaveInstructionButton"
                            Content="💾 Save"
                            Background="{ThemeResource MaterialSurfaceVariantBrush}"
                            Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                            BorderThickness="0"
                            CornerRadius="6"
                            Padding="12,8"
                            FontSize="12"
                            IsEnabled="False"
                            Click="OverlaySaveInstructionButton_Click"/>
                  </StackPanel>
                </StackPanel>
              </Border>

              <!-- Right Panel: Preview Editor -->
              <Border Grid.Column="2"
                      Background="{ThemeResource MaterialSurfaceBrush}"
                      BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                      BorderThickness="1"
                      CornerRadius="12"
                      Padding="24">
                <Grid>
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                  </Grid.RowDefinitions>

                  <!-- Header with Toggle -->
                  <Grid Grid.Row="0" Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*"/>
                      <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0"
                               Text="Content Preview"
                               Style="{ThemeResource SubtitleTextBlockStyle}"
                               Foreground="{ThemeResource MaterialOnSurfaceBrush}"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"/>

                    <!-- View Mode Toggle -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                      <TextBlock Text="Raw Text / Summary"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                                 VerticalAlignment="Center"/>
                      <ToggleSwitch x:Name="OverlayViewModeToggle"
                                    OnContent="Summary"
                                    OffContent="Raw Text"
                                    Toggled="OverlayViewModeToggle_Toggled"/>
                    </StackPanel>
                  </Grid>

                  <!-- Content TextBox -->
                  <TextBox x:Name="OverlayPreviewTextBox"
                           Grid.Row="1"
                           Background="{ThemeResource MaterialSurfaceVariantBrush}"
                           BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                           BorderThickness="1"
                           CornerRadius="8"
                           Padding="16"
                           MinHeight="300"
                           TextWrapping="Wrap"
                           AcceptsReturn="True"
                           IsReadOnly="True"
                           ScrollViewer.VerticalScrollBarVisibility="Auto"
                           ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                           PlaceholderText="No content loaded. Upload a file to see its content here..."
                           FontFamily="Consolas, Courier New, monospace"
                           FontSize="12"/>
                </Grid>
              </Border>
            </Grid>

            <!-- Loading Overlay -->
            <Border x:Name="OverlayLoadingOverlay"
                    Grid.RowSpan="2"
                    Background="{ThemeResource MaterialScrimBrush}"
                    Visibility="Collapsed">
              <StackPanel HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Spacing="16">
                <ProgressRing IsActive="True"
                              Width="48"
                              Height="48"
                              Foreground="{ThemeResource MaterialPrimaryBrush}"/>
                <TextBlock x:Name="OverlayLoadingText"
                           Text="Processing file..."
                           Style="{ThemeResource SubtitleTextBlockStyle}"
                           Foreground="{ThemeResource MaterialOnSurfaceBrush}"
                           HorizontalAlignment="Center"
                           FontWeight="Medium"/>
              </StackPanel>
            </Border>
          </Grid>
          
          <!-- FileSearch Overlay - Positioned within chat content area -->
          <controls:FileSearchPanel x:Name="FileSearchOverlay" 
                                    Grid.RowSpan="3"
                                    Visibility="Collapsed" 
                                    Canvas.ZIndex="1001"
                                    BackRequested="FileSearchOverlay_BackRequested"/>
          
          <!-- Instruction Shortcuts Form Overlay - Small overlay for add/edit form only -->
          <Grid x:Name="InstructionFormOverlay" 
                Grid.RowSpan="3"
                Visibility="Collapsed" 
                Canvas.ZIndex="1002"
                Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
            
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Header Navigation Bar -->
            <Border Grid.Row="0" 
                    Background="{ThemeResource MaterialSurfaceBrush}"
                    BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="24,16">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto"/>
                  <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Back Button -->
                <Button Grid.Column="0"
                        x:Name="BackFromInstructionFormButton"
                        Click="BackFromInstructionFormButton_Click"
                        Background="#19FFFFFF"
                        BorderBrush="#28FFFFFF"
                        BorderThickness="1"
                        CornerRadius="6"
                        Padding="12,8"
                        ToolTipService.ToolTip="Back">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon Glyph="&#xE72B;" 
                              FontSize="16" 
                              Foreground="#DCFFFFFF"/>
                    <TextBlock Text="Back"
                               Foreground="#DCFFFFFF"
                               FontWeight="Medium"/>
                  </StackPanel>
                </Button>

                <!-- Page Title -->
                <TextBlock Grid.Column="1"
                           x:Name="FormOverlayTitle"
                           Text="Add Instruction"
                           Style="{ThemeResource TitleTextBlockStyle}"
                           Foreground="{ThemeResource MaterialOnSurfaceBrush}"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"
                           FontWeight="SemiBold"/>
              </Grid>
            </Border>

            <!-- Form Content with Resizable Split Layout -->
            <Grid Grid.Row="1" Margin="24">
              <Grid.ColumnDefinitions>
                <!-- Left Panel: Form Fields (resizable) -->
                <ColumnDefinition x:Name="FormLeftColumn" Width="400" MinWidth="300"/>
                <!-- Splitter -->
                <ColumnDefinition Width="Auto"/>
                <!-- Right Panel: Instruction + Buttons -->
                <ColumnDefinition Width="*" MinWidth="300"/>
              </Grid.ColumnDefinitions>

              <!-- Left Panel: Form Fields -->
              <Border Grid.Column="0"
                      Background="{ThemeResource MaterialSurfaceBrush}"
                      BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                      BorderThickness="1"
                      CornerRadius="8"
                      Padding="20">
                
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Spacing="16">
                    <!-- Name Field -->
                    <StackPanel Spacing="6">
                      <TextBlock Text="Name"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                                 FontWeight="Medium" />
                      <TextBox x:Name="FormNameTextBox"
                               PlaceholderText="Enter instruction name"
                               Background="{ThemeResource MaterialSurfaceVariantBrush}"
                               BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                               BorderThickness="1"
                               CornerRadius="4"
                               Padding="12,8" />
                    </StackPanel>
                    
                    <!-- Shortcut Field -->
                    <StackPanel Spacing="6">
                      <TextBlock Text="Shortcut"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                                 FontWeight="Medium" />
                      <TextBox x:Name="FormShortcutTextBox"
                               PlaceholderText="e.g., sum, trans, debug (max 20 chars)"
                               Background="{ThemeResource MaterialSurfaceVariantBrush}"
                               BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                               BorderThickness="1"
                               CornerRadius="4"
                               Padding="12,8"
                               MaxLength="20"
                               TextChanged="FormShortcutTextBox_TextChanged" />
                      <TextBlock x:Name="FormShortcutValidationText"
                                 Text="No underscores or spaces allowed"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource SystemErrorTextColor}"
                                 Visibility="Collapsed" />
                    </StackPanel>
                    
                    <!-- Language Field -->
                    <StackPanel Spacing="6">
                      <TextBlock Text="Language"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                                 FontWeight="Medium" />
                      <TextBox x:Name="FormLanguageTextBox"
                               PlaceholderText="e.g., en, fr, es"
                               Background="{ThemeResource MaterialSurfaceVariantBrush}"
                               BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                               BorderThickness="1"
                               CornerRadius="4"
                               Padding="12,8" />
                    </StackPanel>
                    
                    <!-- Prompt Type Field -->
                    <StackPanel Spacing="6">
                      <TextBlock Text="Prompt Type"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                                 FontWeight="Medium" />
                      <TextBox x:Name="FormPromptTypeTextBox"
                               PlaceholderText="e.g., summary, translation, analysis"
                               Background="{ThemeResource MaterialSurfaceVariantBrush}"
                               BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                               BorderThickness="1"
                               CornerRadius="4"
                               Padding="12,8" />
                    </StackPanel>
                    
                    <!-- Description Field -->
                    <StackPanel Spacing="6">
                      <TextBlock Text="Description"
                                 Style="{ThemeResource CaptionTextBlockStyle}"
                                 Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                                 FontWeight="Medium" />
                      <TextBox x:Name="FormDescriptionTextBox"
                               PlaceholderText="Brief description of this instruction"
                               Background="{ThemeResource MaterialSurfaceVariantBrush}"
                               BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                               BorderThickness="1"
                               CornerRadius="4"
                               Padding="12,8"
                               Height="80"
                               TextWrapping="Wrap"
                               AcceptsReturn="True" />
                    </StackPanel>
                    
                    <!-- Is Active Checkbox -->
                    <CheckBox x:Name="FormIsActiveCheckBox"
                              Content="Is Active"
                              IsChecked="True"
                              Foreground="{ThemeResource MaterialOnSurfaceBrush}" />
                  </StackPanel>
                </ScrollViewer>
              </Border>

              <!-- Resizable Splitter -->
              <Border Grid.Column="1" 
                      x:Name="FormSplitterHandle"
                      Width="8" 
                      Background="Transparent"
                      Margin="4,0"
                      PointerPressed="FormSplitterHandle_PointerPressed"
                      PointerMoved="FormSplitterHandle_PointerMoved"
                      PointerReleased="FormSplitterHandle_PointerReleased"
                      PointerEntered="FormSplitterHandle_PointerEntered"
                      PointerExited="FormSplitterHandle_PointerExited">
                <Border Width="2" 
                        Background="{ThemeResource MaterialOutlineVariantBrush}"
                        HorizontalAlignment="Center"/>
              </Border>

              <!-- Right Panel: Instruction + Buttons -->
              <Border Grid.Column="2"
                      Background="{ThemeResource MaterialSurfaceBrush}"
                      BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                      BorderThickness="1"
                      CornerRadius="8"
                      Padding="20">
                
                <Grid>
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                  </Grid.RowDefinitions>

                  <!-- Instruction Label -->
                  <TextBlock Grid.Row="0"
                             Text="Instruction"
                             Style="{ThemeResource CaptionTextBlockStyle}"
                             Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                             FontWeight="Medium"
                             Margin="0,0,0,6" />

                  <!-- Instruction TextBox -->
                  <TextBox Grid.Row="1"
                           x:Name="FormInstructionTextBox"
                           PlaceholderText="Enter the full instruction text (max 500 characters)"
                           Background="{ThemeResource MaterialSurfaceVariantBrush}"
                           BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                           BorderThickness="1"
                           CornerRadius="4"
                           Padding="12,8"
                           MaxLength="500"
                           TextWrapping="Wrap"
                           AcceptsReturn="True"
                           VerticalAlignment="Stretch"
                           TextChanged="FormInstructionTextBox_TextChanged" />

                  <!-- Character Counter -->
                  <TextBlock Grid.Row="2"
                             x:Name="FormCharacterCountText"
                             Text="0 / 500 characters"
                             Style="{ThemeResource CaptionTextBlockStyle}"
                             Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                             HorizontalAlignment="Right"
                             Margin="0,6,0,16" />

                  <!-- Action Buttons -->
                  <StackPanel Grid.Row="3"
                              Orientation="Horizontal"
                              Spacing="12"
                              HorizontalAlignment="Right">
                    <Button x:Name="FormCancelButton"
                            Content="Cancel"
                            Background="Transparent"
                            Foreground="{ThemeResource MaterialOnSurfaceBrush}"
                            BorderBrush="{ThemeResource MaterialOutlineVariantBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="20,8"
                            Click="FormCancelButton_Click" />
                    
                    <Button x:Name="FormSaveButton"
                            Content="Save"
                            Background="{ThemeResource MaterialPrimaryBrush}"
                            Foreground="{ThemeResource MaterialOnPrimaryBrush}"
                            BorderThickness="0"
                            CornerRadius="8"
                            Padding="20,8"
                            FontWeight="Medium"
                            Click="FormSaveButton_Click" />
                  </StackPanel>
                </Grid>
              </Border>
            </Grid>
          </Grid>
          
          <!-- Chat Header -->
          <Border Grid.Row="0"
                  BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                  BorderThickness="0,0,0,1"
                  Padding="16,12">
            <Grid>
              <TextBlock Text="Chat"
                         FontWeight="SemiBold"
                         FontSize="16"
                         HorizontalAlignment="Left" />
              
              <StackPanel Orientation="Horizontal"
                          HorizontalAlignment="Right"
                          Spacing="12">
                
                <TextBlock x:Name="ContextSizeDisplay"
                           Text="Context size: 0 tokens"
                           FontSize="12"
                           Foreground="{ThemeResource MaterialOnSurfaceVariantBrush}"
                           VerticalAlignment="Center" />
                <Button x:Name="ClearSessionButton"
                        Background="#19FFFFFF"
                        BorderThickness="1"
                        BorderBrush="#28FFFFFF"
                        CornerRadius="6"
                        Padding="12,6"
                        ToolTipService.ToolTip="Clear chat history and file context"
                        Click="ClearSessionButton_Click">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <FontIcon Glyph="&#xE74D;" FontSize="14" Foreground="#DCFFFFFF" />
                    <TextBlock Text="Clear Session" FontSize="13" Foreground="#DCFFFFFF" />
                  </StackPanel>
                </Button>
                <Button Background="Transparent"
                        BorderThickness="0"
                        Width="32"
                        Height="32"
                        ToolTipService.ToolTip="Download">
                  <FontIcon Glyph="&#xE118;" FontSize="14" />
                </Button>
                <Button Background="Transparent"
                        BorderThickness="0"
                        Width="32"
                        Height="32"
                        ToolTipService.ToolTip="More options">
                  <FontIcon Glyph="&#xE10C;" FontSize="14" />
                </Button>
              </StackPanel>
            </Grid>
          </Border>
          
          <!-- Chat Messages Area -->
          <Grid Grid.Row="1">
            <ScrollViewer x:Name="ChatScrollViewer"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          ZoomMode="Disabled"
                          Padding="16,8">
            <StackPanel x:Name="ChatMessagesPanel"
                        Spacing="12">
              
              <!-- Empty State (shown when no messages) -->
              <StackPanel x:Name="EmptyStatePanel"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Spacing="8"
                          Margin="0,40">
                <TextBlock Text="No messages here yet"
                           FontSize="16"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           HorizontalAlignment="Center" />
                <TextBlock Text="Send a message to chat with AI"
                           FontSize="14"
                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                           HorizontalAlignment="Center" />
              </StackPanel>
              
              <!-- Sample User Message -->
              <!-- 
              <Grid HorizontalAlignment="Right" MaxWidth="400" Margin="0,4">
                <Border Background="{ThemeResource AccentFillColorDefaultBrush}"
                        CornerRadius="16,16,4,16"
                        Padding="12,8">
                  <TextBlock Text="Hello, can you help me with something?"
                             Foreground="White"
                             TextWrapping="Wrap"
                             FontSize="14" />
                </Border>
              </Grid>
              -->
              
              <!-- Sample AI Message -->
              <!--
              <Grid HorizontalAlignment="Left" MaxWidth="500" Margin="0,4">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                <Border Grid.Row="0"
                        Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="16,16,16,4"
                        Padding="12,8">
                  <TextBlock Text="Of course! I'd be happy to help you. What do you need assistance with?"
                             Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                             TextWrapping="Wrap"
                             FontSize="14" />
                </Border>
                
                <StackPanel Grid.Row="1" 
                            Orientation="Horizontal" 
                            HorizontalAlignment="Right"
                            Margin="0,4,0,0"
                            Spacing="8">
                  <Button Background="Transparent"
                          BorderThickness="0"
                          Padding="8,4"
                          ToolTipService.ToolTip="Copy message">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <FontIcon Glyph="&#xE8C8;" FontSize="12" />
                      <TextBlock Text="Copy" FontSize="12" />
                    </StackPanel>
                  </Button>
                </StackPanel>
              </Grid>
              -->
              
            </StackPanel>
          </ScrollViewer>
          
          <!-- Scroll to Bottom Indicator -->
          <Button x:Name="ScrollIndicator"
                  HorizontalAlignment="Right"
                  VerticalAlignment="Bottom"
                  Margin="16,0,16,16"
                  Background="{ThemeResource AccentFillColorDefaultBrush}"
                  BorderThickness="0"
                  CornerRadius="20"
                  Width="40"
                  Height="40"
                  Visibility="Collapsed"
                  Click="ScrollIndicator_Click"
                  ToolTipService.ToolTip="Scroll to bottom">
            <FontIcon Glyph="&#xE96E;" 
                      Foreground="White" 
                      FontSize="16" />
          </Button>
          </Grid>
          
          <!-- Chat Input Area -->
          <Border Grid.Row="2"
                  BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                  BorderThickness="0,1,0,0"
                  Padding="16,12">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              
              <Button x:Name="ContextMenuButton"
                      Grid.Column="0"
                      Background="Transparent"
                      BorderThickness="1"
                      BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                      CornerRadius="20"
                      Width="40"
                      Height="40"
                      Margin="0,0,8,0"
                      Click="ContextMenuButton_Click"
                      ToolTipService.ToolTip="Context options">
                <FontIcon Glyph="&#xE109;" FontSize="16" />
              </Button>
              
              <TextBox x:Name="ChatInput"
                       Grid.Column="1"
                       PlaceholderText="Type a message"
                       BorderThickness="1"
                       CornerRadius="20"
                       Padding="16,8"
                       VerticalAlignment="Center"
                       KeyDown="ChatInput_KeyDown" />
              
              <AppBarButton x:Name="SendButton"
                            Grid.Column="2"
                            Width="40"
                            Height="40"
                            Margin="8,0,0,0"
                            Click="SendButton_Click"
                            ToolTipService.ToolTip="Send message">
                <AppBarButton.Icon>
                  <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}"
                            Glyph="&#xE122;"/>
                </AppBarButton.Icon>
              </AppBarButton>
            </Grid>
          </Border>
          
        </Grid>
      </Border>
      
    </Grid>
  </Grid>
</Page>